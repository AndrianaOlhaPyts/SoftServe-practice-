@model IEnumerable<Cinema.Models.DataBaseModels.Ticket>

@{
    ViewData["Title"] = "Select Seats";
}

<h2>Select Seats</h2>

<div class="hall-layout">
    @foreach (var row in Model.GroupBy(t => t.Seat.RowId).OrderBy(g => g.Key))
    {
        <div class="row-layout">
            @foreach (var ticket in row.OrderBy(t => t.Seat.SeatNumber))
            {
                <div class="seat @(ticket.Seat.SeatType.ToLower())
            @(ticket.IsBooked ? "booked" : "")
            @(ticket.IsPaid ? "sold" : "")"
                     data-ticket-id="@ticket.Id"
                     data-seat-number="@ticket.Seat.SeatNumber"
                     data-seat-type="@ticket.Seat.SeatType"
                     data-price="@ticket.Price">
                    <span>@ticket.Seat.SeatNumber</span>
                    <span class="ticket-price">@ticket.Price$</span>
                </div>


                @* Add gap between VIP seats *@
                @if (ticket.Seat.SeatType.ToLower() == "vip")
                {
                    <div class="vip-gap"></div>
                }
            }
        </div>
    }
</div>


<div class="screen-container">
    <div class="screen">Екран</div>
</div>


<!-- Кнопка для підтвердження вибору -->
<button id="pay-btn" style="display:none;">Оплатити</button>

<!-- Кнопка для підтвердження вибору -->
<button id="confirm-selection-btn">Confirm Selection</button>

<div class="total-price">
    Total Price: <span id="totalPrice">0</span>$
</div>

<style>
    .hall-layout {
        display: flex;
        flex-direction: column;
        gap: 10px; /* Збільшено відстань між рядами */
        align-items: center;
        margin-bottom: 30px;
    }

    .row-layout {
        display: flex;
        gap: 10px; /* Збільшено проміжок між місцями */
        align-items: center;
    }

    .seat {
        width: 50px;  /* Збільшено ширину */
        height: 50px; /* Збільшено висоту */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid black;
        font-size: 16px; /* Збільшено шрифт */
        padding: 5px;
    }

    .ticket-price {
        font-size: 14px;
        font-weight: bold;
        color: green;
        margin-top: 5px;
    }

    .sold {
        background-color: darkred !important;
        color: white;
        cursor: not-allowed;
    }


    .booked {
        background-color: red !important;
        cursor: not-allowed;
    }

    .standard { background-color: lightgray; }
    .vip { background-color: gold; }
    .disabled { background-color: blue; }
    .selected { background-color: lightgreen; }

    .vip-gap {
        width: 30px; /* Більший відступ */
    }

    .screen-container {
        display: flex;
        justify-content: center;
        width: 100%;
    }

    .screen {
        width: 50%;
        height: 40px; /* Збільшено висоту */
        background-color: black;
        color: white;
        text-align: center;
        font-size: 20px; /* Збільшено шрифт */
        font-weight: bold;
        margin-top: 30px;
        border-radius: 8px;
        line-height: 40px; /* Вирівняно текст по вертикалі */
    }
</style>

<script>
        let selectedTicketIds = [];

    document.querySelectorAll(".seat:not(.booked)").forEach(seat => {
        seat.addEventListener("click", function () {
            const seatPrice = parseFloat(this.getAttribute("data-price"));
            const ticketId = this.getAttribute("data-ticket-id");

            if (this.classList.contains("selected")) {
                this.classList.remove("selected");
                updateTotalPrice(-seatPrice);
                selectedTicketIds = selectedTicketIds.filter(id => id !== ticketId);
            } else {
                this.classList.add("selected");
                updateTotalPrice(seatPrice);
                selectedTicketIds.push(ticketId);
            }

            document.getElementById("pay-btn").style.display = selectedTicketIds.length > 0 ? "block" : "none";
        });
    });

    function updateTotalPrice(priceChange) {
        let totalPrice = parseFloat(document.getElementById("totalPrice").innerText);
        totalPrice += priceChange;
        document.getElementById("totalPrice").innerText = totalPrice.toFixed(2);
    }

    // Підтвердження вибору місць
    document.getElementById("confirm-selection-btn").addEventListener("click", async () => {
        if (selectedTicketIds.length === 0) {
            alert("Будь ласка, виберіть хоча б одне місце.");
            return;
        }

        const response = await fetch('/Tickets/ConfirmSelection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(selectedTicketIds.map(id => ({ ticketId: id })))
        });

        if (response.ok) {
            alert("Місця вибрано. Тепер можете оплатити.");
            document.getElementById("pay-btn").style.display = "block";
        } else {
            alert("Помилка під час вибору місць.");
        }
    });

    // Перенаправлення на сторінку оплати
    document.getElementById("pay-btn").addEventListener("click", () => {
        const totalPrice = document.getElementById("totalPrice").innerText;
        window.location.href = `/Tickets/Payment?totalPrice=${totalPrice}&ticketIds=${selectedTicketIds.join(',')}`;
    });
</script>
